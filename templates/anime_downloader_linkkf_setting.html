{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('.static', filename='css/mobile_custom.css') }}"/>
<link rel="stylesheet" href="{{ url_for('.static', filename='css/' ~ arg['sub'] ~ '.css') }}"/>

<div id="linkkf_setting_wrapper" class="container-fluid mt-4 mx-auto content-cloak" style="max-width: 100%; padding-left: 5px; padding-right: 5px;">
  
  <div class="glass-card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white font-weight-bold"><i class="bi bi-gear-fill mr-2"></i>Linkkf 설정</h2>
        <div>
            <button type="button" class="btn btn-outline-info btn-sm mr-2" id="btn-self-update" title="최신 버전으로 업데이트">
                <i class="bi bi-arrow-repeat"></i> 업데이트
            </button>
            {{ macros.m_button_group([['globalSettingSaveBtn', '설정 저장']])}}
        </div>
    </div>

    {{ macros.m_row_start('5') }}
    {{ macros.m_row_end() }}
    
    <nav>
      {{ macros.m_tab_head_start() }}
        {{ macros.m_tab_head('normal', '일반', true) }}
        {{ macros.m_tab_head('auto', '자동등록', false) }}
        {{ macros.m_tab_head('action', '기타', false) }}
      {{ macros.m_tab_head_end() }}
    </nav>
    
    <form id="setting" class="mt-4">
    <div class="tab-content" id="nav-tabContent">
    {{ macros.m_tab_content_start('normal', true) }}
      {{ macros.setting_input_text_and_buttons('linkkf_url', 'linkkf URL', [['go_btn', 'GO']], value=arg['linkkf_url']) }}
      
      <!-- 저장 폴더 (탐색 버튼 포함) -->
      <div class="row" style="padding-top: 10px; padding-bottom:10px; align-items: center;">
        <div class="col-sm-3 set-left">
          <strong>저장 폴더</strong>
        </div>
        <div class="col-sm-9">
          <div class="input-group col-sm-9">
            <input type="text" class="form-control form-control-sm" id="linkkf_download_path" name="linkkf_download_path" value="{{arg['linkkf_download_path']}}">
            <div class="btn-group btn-group-sm flex-wrap mr-2" role="group" style="padding-left:5px; padding-top:0px">
              <button type="button" class="btn btn-sm btn-outline-primary" id="browse_folder_btn" title="폴더 탐색">
                <i class="bi bi-folder2-open"></i> 탐색
              </button>
            </div>
          </div>
          <div style="padding-left:20px; padding-top:5px;">
            <em>정상적으로 다운 완료 된 파일이 이동할 폴더 입니다.</em>
          </div>
        </div>
      </div>
      
      {{ macros.setting_input_int('linkkf_max_ffmpeg_process_count', '동시 다운로드 에피소드 수', value=arg['linkkf_max_ffmpeg_process_count'], desc='동시에 다운로드할 에피소드 개수입니다.') }}
      {{ macros.setting_select('linkkf_download_method', '다운로드 방법', [['ffmpeg', 'ffmpeg (기본)'], ['ytdlp', 'yt-dlp (단일쓰레드)'], ['aria2c', 'yt-dlp (멀티쓰레드/aria2c)']], col='3', value=arg['linkkf_download_method'], desc='aria2c 선택 시 병렬 다운로드로 속도가 향상됩니다.') }}
      {{ macros.setting_input_int('linkkf_download_threads', '멀티쓰레드 갯수', value=arg['linkkf_download_threads'], desc='yt-dlp/aria2c 사용 시 적용될 병렬 다운로드 쓰레드 수입니다. (기본 16)') }}
      {{ macros.setting_checkbox('linkkf_order_desc', '요청 화면 최신순 정렬', value=arg['linkkf_order_desc'], desc='On : 최신화부터, Off : 1화부터') }}
      {{ macros.setting_checkbox('linkkf_auto_make_folder', '제목 폴더 생성', value=arg['linkkf_auto_make_folder'], desc='제목으로 폴더를 생성하고 폴더 안에 다운로드합니다.') }}
      <div id="linkkf_auto_make_folder_div" class="collapse pl-4 border-left ml-3" style="border-color: rgba(255,255,255,0.1) !important;">
        {{ macros.setting_input_text('linkkf_finished_insert', '완결 표시', col='3', value=arg['linkkf_finished_insert'], desc=['완결된 컨텐츠 폴더명 앞에 넣을 문구입니다.']) }}
        {{ macros.setting_checkbox('linkkf_auto_make_season_folder', '시즌 폴더 생성', value=arg['linkkf_auto_make_season_folder'], desc=['On : Season 번호 폴더를 만듭니다.']) }}
      </div>
        {{ macros.setting_checkbox('linkkf_uncompleted_auto_enqueue', '자동으로 다시 받기', value=arg['linkkf_uncompleted_auto_enqueue'], desc=['On : 플러그인 로딩시 미완료인 항목은 자동으로 다시 받습니다.']) }}
    {{ macros.m_tab_content_end() }}

    {{ macros.m_tab_content_start('auto', false) }}
      {{ macros.global_setting_scheduler_button(arg['scheduler'], arg['is_running']) }}
      {{ macros.setting_input_text('linkkf_interval', '스케쥴링 실행 정보', value=arg['linkkf_interval'], col='3', desc=['Inverval(minute 단위)이나 Cron 설정']) }}
      {{ macros.setting_checkbox('linkkf_auto_start', '시작시 자동실행', value=arg['linkkf_auto_start'], desc='On : 시작시 자동으로 스케쥴러에 등록됩니다.') }}
      <!-- 자동 다운로드 작품 코드 - Tag Chips UI -->
      <div class="row" style="padding-top: 10px; padding-bottom:10px;">
        <div class="col-sm-3 set-left"><strong>자동 다운로드할 작품 코드</strong></div>
        <div class="col-sm-9">
          <input type="hidden" id="linkkf_auto_code_list" name="linkkf_auto_code_list" value="{{arg['linkkf_auto_code_list']}}">
          <div id="tag_chips_container" class="tag-chips-wrapper mb-2"></div>
          <div class="input-group input-group-sm">
            <input type="text" id="new_tag_input" class="form-control" placeholder="작품명 입력 후 Enter (all: 모두 받기)">
            <div class="input-group-append"><button type="button" class="btn btn-outline-primary" id="add_tag_btn"><i class="bi bi-plus-lg"></i> 추가</button></div>
          </div>
          <div style="padding-top:5px;"><em class="text-muted">Enter로 추가, X로 삭제, 드래그 순서변경 | all 입력시 모두 받기</em></div>
        </div>
      </div>
      {{ macros.setting_checkbox('linkkf_auto_mode_all', '에피소드 모두 받기', value=arg['linkkf_auto_mode_all'], desc=['On : 이전 에피소드를 모두 받습니다.', 'Off : 최신 에피소드만 받습니다.']) }}
    {{ macros.m_tab_content_end() }}

    </div><!--tab-content-->
    </form>
  </div>
</div> <!--전체-->

<!-- 폴더 탐색 모달 -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" role="dialog" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1);">
      <div class="modal-header" style="border-color: rgba(255,255,255,0.1);">
        <h5 class="modal-title text-white" id="folderBrowserModalLabel">
          <i class="bi bi-folder2-open mr-2"></i>폴더 선택
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <button type="button" class="btn btn-sm btn-outline-secondary mr-2" id="folder_go_up" title="상위 폴더">
            <i class="bi bi-arrow-up"></i>
          </button>
          <div class="flex-grow-1 px-3 py-2 rounded" style="background: rgba(0,0,0,0.3); font-family: monospace; color: #94a3b8;">
            <span id="current_path_display">/</span>
          </div>
        </div>
        <div id="folder_list" style="min-height: 300px; max-height: 600px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px;">
          <div class="text-center text-muted py-4">
            <i class="bi bi-arrow-repeat spin"></i> 로딩 중...
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border-color: rgba(255,255,255,0.1);">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="folder_select_btn">
          <i class="bi bi-check-lg mr-1"></i>선택
        </button>
      </div>
    </div>
  </div>
</div>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

<style>
    /* Global Background */
    body {
        font-family: 'NamumSquareNeo', system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Noto Sans, Liberation Sans, Arial, sans-serif;
        background-image: linear-gradient(135deg, #1f2937, #111827, #0f172a);
        color: #e2e8f0;
        min-height: 100vh;
    }

    /* Glass Card Container */
    .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Tabs Styling */
    .nav-tabs {
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-tabs .nav-link {
        color: #94a3b8;
        border: none;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
    }
    
    .nav-tabs .nav-link:hover {
        color: #e2e8f0;
        background: rgba(255, 255, 255, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: #60a5fa !important;
        background: rgba(30, 41, 59, 0.8) !important;
        border-bottom: 2px solid #60a5fa !important;
    }

    /* Navigation Menu Override (Top Sub-menu) */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important; /* Pill shape container */
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important; /* Fit content */
        flex-wrap: wrap; /* allow wrap on small screens */
        justify-content: center;
        width: auto !important; /* Prevent full width */
        margin-bottom: 20px;
    }

    /* Navigation (Tabs) Optimization */
    /* Navigation Menu Override */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(6, 78, 59, 0.4) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(16, 185, 129, 0.1);
        border-radius: 50rem !important;
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important;
        gap: 4px;
        margin-bottom: 20px;
    }

    ul.nav.nav-pills .nav-link {
        color: #d1fae5 !important;
        font-weight: 600 !important;
        padding: 8px 20px !important;
        border-radius: 50rem !important;
        transition: all 0.3s ease !important;
        border: 1px solid transparent !important;
    }

    ul.nav.nav-pills .nav-link:hover {
        background-color: rgba(16, 185, 129, 0.1) !important;
        color: #fff !important;
        transform: translateY(-1px);
    }

    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
    }

    /* Form Controls */
    .form-control, .custom-select, textarea {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #f1f5f9 !important;
        border-radius: 8px !important;
    }
    
    .form-control:focus, .custom-select:focus, textarea:focus {
        background-color: rgba(0, 0, 0, 0.5) !important;
        border-color: #10b981 !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.25) !important;
    }

    /* Labels & Text */
    label, .col-form-label {
        font-weight: 600;
        color: #cbd5e1;
    }
    
    .text-muted {
        color: #94a3b8 !important;
    }

    /* Buttons */
    .btn {
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 8px 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-primary, #globalSettingSaveBtn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:hover, #globalSettingSaveBtn:hover {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
    }
    
    /* GO Button specific (Input Group) */
    #go_btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        border-radius: 0 8px 8px 0 !important; /* Fix for input group */
        margin-left: -1px;
    }
    
    #go_btn:hover {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        z-index: 5;
    }

    .btn-outline-primary {
        color: #60a5fa;
        border: 1px solid #60a5fa;
        background: transparent;
    }
    
    .btn-outline-primary:hover {
        background: rgba(96, 165, 250, 0.1);
        color: #93c5fd;
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
    }
    
    .btn:active {
        transform: translateY(0) !important;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
    }

    /* Custom Checkbox/Switch Override (if Bootstrap switch is used) */
    .custom-control-label::before {
        background-color: rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.2);
    }
    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #10b981;
        border-color: #10b981;
    }

    /* Collapse Borders */
    /* Folder Browser Modal Styles */
    .folder-item {
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex !important;
        align-items: center;
        width: 100%;
        overflow: hidden;
    }
    .folder-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .folder-item span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }
    .folder-item.selected {
        background: rgba(16, 185, 129, 0.3) !important;
    }
    /* Tag Chips Styles */
    .tag-chips-wrapper { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; min-height: 60px; background: rgba(0,0,0,0.2); border: 1px dashed rgba(255,255,255,0.15); border-radius: 8px; }
    .tag-chips-wrapper:empty::before { content: '작품이 없습니다.'; color: #64748b; font-style: italic; }
    .tag-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.4)); border: 1px solid rgba(16,185,129,0.4); border-radius: 20px; font-size: 0.9rem; color: #e2e8f0; cursor: grab; transition: all 0.2s ease; }
    .tag-chip:hover { background: linear-gradient(135deg, rgba(16,185,129,0.5), rgba(5,150,105,0.6)); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .tag-chip .tag-text { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tag-chip .tag-remove { width: 18px; height: 18px; background: rgba(239,68,68,0.5); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
    .tag-chip .tag-remove:hover { background: rgba(239,68,68,0.9); }
    .tag-chip .tag-index { width: 20px; height: 20px; background: rgba(0,0,0,0.3); border-radius: 50%; font-size: 0.7rem; color: #94a3b8; display: flex; align-items: center; justify-content: center; }
</style>

<script type="text/javascript">
var package_name = "{{arg['package_name'] }}";
var sub = "{{arg['sub'] }}";
var current_data = null;


$(document).ready(function(){
  // Width Fix
  $("#main_container").removeClass("container").addClass("container-fluid");
  
  use_collapse('linkkf_auto_make_folder');
});

$('#ani365_auto_make_folder').change(function() {
  use_collapse('linkkf_auto_make_folder');
});


$("body").on('click', '#go_btn', function(e){
  e.preventDefault();
  let url = document.getElementById("linkkf_url").value
  window.open(url, "_blank");
});

// ======================================
// 폴더 탐색 기능
// ======================================
var currentBrowsePath = '';
var parentPath = null;

$('#browse_folder_btn').on('click', function() {
  var initialPath = $('#linkkf_download_path').val() || '';
  loadFolderList(initialPath);
  $('#folderBrowserModal').modal('show');
});

function loadFolderList(path) {
  $('#folder_list').html('<div class="text-center text-muted py-4"><i class="bi bi-arrow-repeat"></i> 로딩 중...</div>');
  
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/browse_dir',
    type: 'POST',
    data: { path: path },
    dataType: 'json',
    success: function(ret) {
      if (ret.ret === 'success') {
        currentBrowsePath = ret.current_path;
        parentPath = ret.parent_path;
        $('#current_path_display').text(currentBrowsePath);
        $('#folder_go_up').prop('disabled', !parentPath);
        
        var html = '';
        if (parentPath) {
          html += '<div class="folder-item folder-parent d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(parentPath) + '" style="cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);">';
          html += '<i class="bi bi-folder-symlink text-info mr-2"></i><span class="text-light">..</span><span class="text-muted ml-2">(상위 폴더)</span></div>';
        }
        html += '<div class="folder-item folder-current d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(currentBrowsePath) + '" style="cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);">';
        html += '<i class="bi bi-folder-check text-success mr-2"></i><span class="text-light">.</span><span class="text-muted ml-2">(현재 폴더)</span></div>';
        
        if (ret.directories.length === 0) {
          html += '<div class="text-center text-muted py-3"><small>하위 폴더 없음</small></div>';
        } else {
          for (var i = 0; i < ret.directories.length; i++) {
            var dir = ret.directories[i];
            html += '<div class="folder-item d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(dir.path) + '" style="cursor: pointer;">';
            html += '<i class="bi bi-folder-fill text-warning mr-2"></i><span class="text-light">' + escapeHtml(dir.name) + '</span></div>';
          }
        }
        $('#folder_list').html(html);
      } else {
        $('#folder_list').html('<div class="text-center text-danger py-4">로드 실패: ' + (ret.error || '알 수 없는 오류') + '</div>');
      }
    },
    error: function(xhr, status, error) {
      $('#folder_list').html('<div class="text-center text-danger py-4">에러: ' + error + '</div>');
    }
  });
}

$('#folder_list').on('dblclick', '.folder-item', function() { loadFolderList($(this).data('path')); });
$('#folder_list').on('click', '.folder-item', function() {
  $('.folder-item').removeClass('selected').css('background', '');
  $(this).addClass('selected').css('background', 'rgba(16, 185, 129, 0.3)');
  currentBrowsePath = $(this).data('path');
  $('#current_path_display').text(currentBrowsePath);
});
$('#folder_go_up').on('click', function() { if (parentPath) loadFolderList(parentPath); });
$('#folder_select_btn').on('click', function() {
  $('#linkkf_download_path').val(currentBrowsePath);
  $('#folderBrowserModal').modal('hide');
  $.notify('저장 폴더가 설정되었습니다: ' + currentBrowsePath, {type: 'success'});
});
function escapeHtml(text) { var div = document.createElement('div'); div.appendChild(document.createTextNode(text)); return div.innerHTML; }

</script>

<style>
    /* Smooth Load Transition */
    .content-cloak, 
    #menu_module_div, 
    #menu_page_div {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }
    
    /* Staggered Delays for Natural Top-Down Flow */
    #menu_module_div.visible {
        opacity: 1;
        transition-delay: 0ms;
    }

    #menu_page_div.visible {
        opacity: 1;
        transition-delay: 150ms;
    }

    .content-cloak.visible {
        opacity: 1;
        transition-delay: 300ms;
    }
    
    /* Navigation Menu Override (Top Sub-menu) */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important;
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important;
        flex-wrap: wrap;
        justify-content: center;
        width: auto !important;
        margin-bottom: 20px;
    }

    ul.nav.nav-pills .nav-item { margin: 0 2px; }
    ul.nav.nav-pills .nav-link {
        border-radius: 50rem !important;
        padding: 8px 20px !important;
        color: #94a3b8 !important;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    ul.nav.nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff !important;
        transform: translateY(-1px);
    }
    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
    }
</style>

<script type="text/javascript">
$(document).ready(function(){
  // Smooth Load Trigger
  setTimeout(function() {
      $('.content-cloak, #menu_module_div, #menu_page_div').addClass('visible');
  }, 100);
  initTagChips();
});

// Tag Chips 기능
function initTagChips() {
  var value = $('#linkkf_auto_code_list').val().trim();
  if (value) {
    var items = value.split(/[|\n]/).map(s => s.trim()).filter(s => s.length > 0);
    items.forEach(function(item, index) { addTagChip(item, index); });
  }
  updateTagIndices();
}
function addTagChip(text, index) {
  var chip = $('<div class="tag-chip" draggable="true" data-value="'+escapeHtml(text)+'"><span class="tag-index">'+(index+1)+'</span><span class="tag-text" title="'+escapeHtml(text)+'">'+escapeHtml(text)+'</span><span class="tag-remove"><i class="bi bi-x"></i></span></div>');
  $('#tag_chips_container').append(chip);
}
function updateHiddenField() {
  var values = [];
  $('#tag_chips_container .tag-chip').each(function() { values.push($(this).data('value')); });
  $('#linkkf_auto_code_list').val(values.join('|'));
}
function updateTagIndices() {
  $('#tag_chips_container .tag-chip').each(function(i) { $(this).find('.tag-index').text(i+1); });
}
$('#tag_chips_container').on('click', '.tag-remove', function(e) {
  e.stopPropagation();
  var chip = $(this).closest('.tag-chip');
  chip.fadeOut(200, function() { $(this).remove(); updateHiddenField(); updateTagIndices(); });
});
$('#add_tag_btn').on('click', function() { addNewTag(); });
$('#new_tag_input').on('keypress', function(e) { if (e.which === 13) { e.preventDefault(); addNewTag(); } });
function addNewTag() {
  var text = $('#new_tag_input').val().trim();
  if (!text) { $.notify('작품명을 입력하세요', {type:'warning'}); return; }
  var exists = false;
  $('#tag_chips_container .tag-chip').each(function() { if ($(this).data('value') === text) exists = true; });
  if (exists) { $.notify('이미 등록된 작품입니다', {type:'warning'}); return; }
  addTagChip(text, $('#tag_chips_container .tag-chip').length);
  updateHiddenField();
  $('#new_tag_input').val('');
  $.notify('"'+text+'" 추가됨', {type:'success'});
}
var draggedChip = null;
$('#tag_chips_container').on('dragstart', '.tag-chip', function(e) { draggedChip = this; $(this).addClass('dragging'); });
$('#tag_chips_container').on('dragend', '.tag-chip', function() { $(this).removeClass('dragging'); draggedChip = null; updateHiddenField(); updateTagIndices(); });
$('#tag_chips_container').on('dragover', function(e) { e.preventDefault(); var after = getDragAfterElement(this, e.originalEvent.clientX); if (!after) this.appendChild(draggedChip); else this.insertBefore(draggedChip, after); });
function getDragAfterElement(container, x) {
  return [...container.querySelectorAll('.tag-chip:not(.dragging)')].reduce((c, el) => { var box = el.getBoundingClientRect(); var offset = x - box.left - box.width/2; return (offset < 0 && offset > c.offset) ? {offset, element: el} : c; }, {offset: Number.NEGATIVE_INFINITY}).element;
}

// ======================================
// 자가 업데이트 기능
// ======================================
$('#btn-self-update').on('click', function() {
  if (!confirm('최신 코드를 다운로드하고 플러그인을 리로드하시겠습니까?')) return;
  
  var btn = $(this);
  var originalHTML = btn.html();
  btn.prop('disabled', true).html('<i class="bi bi-arrow-repeat spin"></i> 업데이트 중...');
  
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/self_update',
    type: 'POST',
    dataType: 'json',
    success: function(ret) {
      if (ret.ret === 'success') {
        $.notify('<strong>업데이트 완료!</strong> 페이지를 새로고침합니다.', {type: 'success'});
        setTimeout(function() { location.reload(); }, 1500);
      } else {
        $.notify('<strong>업데이트 실패: ' + ret.msg + '</strong>', {type: 'danger'});
      }
    },
    error: function() {
      $.notify('<strong>업데이트 중 오류 발생</strong>', {type: 'danger'});
    },
    complete: function() {
      btn.prop('disabled', false).html(originalHTML);
    }
  });
});
</script>
{% endblock %}