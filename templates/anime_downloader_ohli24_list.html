{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('.static', filename='css/mobile_custom.css') }}"/>
<link rel="stylesheet" href="{{ url_for('.static', filename='css/' ~ arg['sub'] ~ '.css') }}"/>


<div id="ohli24_list_wrapper" class="ohli24-common-wrapper container-fluid mt-4 content-cloak ohli24-list-page">
    <div class="glass-card p-4">
        <div class="ohli24-header">
            <div class="ohli24-header-left">
                <div class="ohli24-icon-box">
                    <i class="bi bi-collection-play-fill text-primary" style="font-size: 1.5rem;"></i>
                </div>
                <div>
                    <h3 class="ohli24-header-title">다운로드 목록</h3>
                    <span class="ohli24-header-subtitle">성공적으로 완료된 에피소드 라이브러리</span>
                </div>
            </div>
        </div>
        <hr style="border-color: rgba(255,255,255,0.05); margin-bottom: 25px;">
        <form id="form_search" class="form-inline mb-4" style="text-align:left; width:100%;">
            <div class="search-container">
                <div class="search-group-left">
                     <select id="order" name="order" class="form-control custom-select">
                        <option value="desc">최근순</option>
                        <option value="asc">오래된 순</option>
                      </select>
                      <select id="option" name="option" class="form-control custom-select">
                        <option value="all">전체</option>
                        <option value="completed">완료</option>
                      </select>
                </div>
                <div class="search-group-right">
                      <input id="search_word" name="search_word" class="form-control custom-input" type="text" placeholder="검색어를 입력하세요..." aria-label="Search">
                      <button id="search" class="btn custom-btn btn-search"><i class="fa fa-search"></i></button>
                      <button id="reset_btn" class="btn custom-btn btn-reset"><i class="fa fa-refresh"></i></button>
                </div>
            </div>
        </form>
        <div id='page1' class="mb-3"></div>
        <div id="list_div"></div>
        <div id='page2' class="mt-3"></div>
    </div>
</div>

    <!-- Custom Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content animate__animated animate__zoomIn" style="background: #1e293b; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
                <div class="modal-body text-center" style="padding: 40px 30px;">
                    <div style="width: 70px; height: 70px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <i class="fa fa-trash animate__animated animate__shakeX animate__infinite" style="color: #ef4444; font-size: 30px;"></i>
                    </div>
                    <h4 style="color: #f1f5f9; font-weight: 700; margin-bottom: 12px;">정말 삭제하시겠습니까?</h4>
                    <p style="color: #94a3b8; font-size: 15px; margin-bottom: 32px;">한 번 삭제된 기록은 다시 복구할 수 없습니다.</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button type="button" class="custom-btn btn-reset" data-dismiss="modal" style="width: 120px;">취소</button>
                        <button type="button" id="confirmDeleteBtn" class="custom-btn" style="width: 120px; background: #ef4444; color: white;">삭제하기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Video Modal Component -->
    {% include 'anime_downloader/components/video_modal.html' %}


    <script src="{{ url_for('.static', filename='js/sjva_global1.js') }}"></script>
    <script src="{{ url_for('.static', filename='js/sjva_ui14.js') }}"></script>
    <script type="text/javascript">
        var package_name = "{{arg['package_name']}}";
        var sub = "{{arg['sub']}}";
        var current_data = null;

        $(document).ready(function () {
            // Force parent container to be fluid to allow full width
            $("#main_container").removeClass("container").addClass("container-fluid");
            
            // Smooth Load Trigger
            setTimeout(function() {
                $('.content-cloak, #menu_module_div, #menu_page_div').addClass('visible');
            }, 100);
            
            global_sub_request_search('1');
        });

        function global_sub_request_search(page, move_top = true) {
            // console.log('........................')
            var formData = get_formdata('#form_search')
            formData += '&page=' + page;
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/web_list3',
                type: "POST",
                cache: false,
                data: formData,
                dataType: "json",
                success: function (data) {
                    // console.log(data)
                    current_data = data;
                    if (move_top) {
                         window.scrollTo(0,0);
                    }
                    make_list(data.list);
                    make_page_html(data.paging);
                }
            });
        }

        $("#search").click(function (e) {
            e.preventDefault();
            global_sub_request_search('1');
        });

        $("body").on('click', '#page', function (e) {
            e.preventDefault();
            global_sub_request_search($(this).data('page'));
        });

        $("#reset_btn").click(function (e) {
            e.preventDefault();
            document.getElementById("order").value = 'desc';
            document.getElementById("option").value = 'all';
            document.getElementById("search_word").value = '';
            global_sub_request_search('1')
        });


        $("body").on('click', '#json_btn', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            for (i in current_data.list) {
                if (current_data.list[i].id == id) {
                    m_modal(current_data.list[i])
                }
            }
        });

        $("body").on('click', '#self_search_btn', function (e) {
            e.preventDefault();
            var search_word = $(this).data('title');
            document.getElementById("search_word").value = search_word;
            global_sub_request_search('1')
        });

        var targetDeleteId = null;

        $("body").on('click', '.btn-remove', function (e) {
            e.preventDefault();
            targetDeleteId = $(this).data('id');
            $('#confirmModal').modal('show');
        });

        $('#confirmDeleteBtn').click(function() {
            if (!targetDeleteId) return;
            
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/db_remove',
                type: "POST",
                cache: false,
                data: {id: targetDeleteId},
                dataType: "json",
                success: function (data) {
                    $('#confirmModal').modal('hide');
                    if (data) {
                        $.notify('<strong>성공적으로 삭제되었습니다.</strong>', {
                            type: 'success'
                        });
                        global_sub_request_search(current_data.paging.current_page, false)
                    } else {
                        $.notify('<strong>삭제 실패</strong>', {
                            type: 'warning'
                        });
                    }
                }
            });
        });

        $("body").on('click', '.btn-request', function (e) {
            e.preventDefault();
            var content_code = $(this).data('content_code');
            $(location).attr('href', '/' + package_name + '/' + sub + '/request?content_code=' + content_code)
        });

        $("body").on('click', '.btn-json', function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            for (i in current_data.list) {
                if (current_data.list[i].id == id) {
                    m_modal(current_data.list[i])
                }
            }
        });

        $("body").on('click', '.btn-self-search', function (e) {
            e.preventDefault();
            var search_word = $(this).data('title');
            document.getElementById("search_word").value = search_word;
            global_sub_request_search('1')
        });

        // Video Modal 초기화
        VideoModal.init({ package_name: package_name, sub: sub });
        
        // 비디오 보기 버튼 클릭 핸들러
        $("body").on('click', '.btn-watch', function (e) {
            e.preventDefault();
            var filePath = $(this).data('path');
            VideoModal.openWithPath(filePath);
        });


        // 비디오 줌/확장 처리 (모바일 Fullscreen 꽉 차게)
        var isVideoZoomed = false;
        $('#btn-video-zoom').click(function() {
            isVideoZoomed = !isVideoZoomed;
            const $video = $('#video-player_html5_api'); // Video.js 내부 태그
            if (isVideoZoomed) {
                $video.css({
                    'object-fit': 'cover',
                    'height': '100%'
                });
                $(this).addClass('active').find('i').removeClass('fa-expand').addClass('fa-compress');
                $.notify('<strong>화면을 꽉 채웠습니다 (일부 잘릴 수 있음)</strong>', {type: 'info', delay: 1000});
            } else {
                $video.css({
                    'object-fit': 'contain',
                    'height': 'auto'
                });
                $(this).removeClass('active').find('i').removeClass('fa-compress').addClass('fa-expand');
                $.notify('<strong>원래 비율로 복원되었습니다</strong>', {type: 'info', delay: 1000});
            }
        });
        
        // 모달 닫을 때 비디오 정지 + 포커스 해제 (aria-hidden 경고 방지)
        var playlistRefreshInterval = null;
        var currentPlayingPath = null;  // 현재 재생 중인 파일 경로 저장
        
        function startPlaylistRefresh() {
            if (playlistRefreshInterval) return;
            playlistRefreshInterval = setInterval(function() {
                if (!currentPlayingPath) return;
                $.ajax({
                    url: '/' + package_name + '/ajax/' + sub + '/get_playlist?path=' + encodeURIComponent(currentPlayingPath),
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        var newPlaylist = data.playlist || [];
                        // 새 에피소드 추가됐는지 확인
                        if (newPlaylist.length > playlist.length) {
                            var addedCount = newPlaylist.length - playlist.length;
                            playlist = newPlaylist;
                            updatePlaylistUI();
                            // 알림 표시
                            $.notify('<i class="fa fa-download"></i> ' + addedCount + '개 에피소드 추가됨!', {type: 'success'});
                        }
                    }
                });
            }, 10000);  // 10초마다 체크
        }
        
        function stopPlaylistRefresh() {
            if (playlistRefreshInterval) {
                clearInterval(playlistRefreshInterval);
                playlistRefreshInterval = null;
            }
        }
        
        $('#videoModal').on('show.bs.modal', function() {
            startPlaylistRefresh();
        });
        
        $('#videoModal').on('hide.bs.modal', function () {
            stopPlaylistRefresh();
            // 포커스된 요소에서 포커스 해제 (aria-hidden 경고 방지)
            document.activeElement.blur();
            // 목록 닫기
            $('#playlist-list-container').hide();
            $('#btn-toggle-playlist').removeClass('active');
        });
        
        $('#videoModal').on('hidden.bs.modal', function () {
            if (videoPlayer) {
                videoPlayer.pause();
            }
            currentPlayingPath = null;
        });

        function make_list(data) {
            let str = '';
            for (let i in data) {
                const item = data[i];
                const statusClass = (item.status == 'completed') ? 'status-completed' : 
                                  (item.status == 'downloading') ? 'status-downloading' : 
                                  (item.status == 'failed') ? 'status-failed' : 'status-wait';
                const statusText = (item.status == 'completed') ? 'COMPLETED' : 
                                 (item.status == 'downloading') ? 'DOWNLOADING' : 
                                 (item.status == 'failed') ? 'FAIL' : 'WAITING';
                
                // Thumbnail
                let imgHtml = '';
                let badgeHtml = '';
                if (item.episode_no) {
                    badgeHtml = `<div class="episode-badge">${item.episode_no}화</div>`;
                }

                if (item.thumbnail) {
                    imgHtml = `${badgeHtml}<img src="${item.thumbnail}" onerror="this.src='https://via.placeholder.com/60x80?text=No+Img'">`;
                } else {
                    imgHtml = `${badgeHtml}<img src="https://via.placeholder.com/60x80?text=No+Img">`;
                }

                // Date
                let createdDate = item.created_time ? item.created_time.split(' ')[0] : '';
                let completedDate = item.completed_time ? item.completed_time.split(' ')[0] : '';
                
                let dateHtml = `<div class="date-tag date-tag-req" title="요청일: ${item.created_time}">
                                    <i class="fa fa-clock-o"></i> <span>시작: ${createdDate}</span>
                                </div>`;
                if (completedDate) {
                    dateHtml += `<div class="date-tag date-tag-done" title="완료일: ${item.completed_time}">
                                    <i class="fa fa-check-circle"></i> <span>완료: ${completedDate}</span>
                                </div>`;
                }

                // Subtitle Line
                let subtitleHtml = '';
                if (item.episode_title) {
                     subtitleHtml = `<div class="episode-subtitle text-muted">${item.episode_title}</div>`;
                }

                str += `
                <div class="episode-card">
                    <div class="episode-card-body">
                        <!-- Left: Thumb -->
                        <div class="episode-thumb">${imgHtml}</div>
                        
                        <!-- Center: Main Info -->
                        <div class="episode-main-info">
                            <div class="episode-title" title="${item.title}">${item.title}</div>
                            ${subtitleHtml}
                            <div class="episode-meta">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                <span class="meta-tag">S${item.season}</span>
                                <span class="meta-tag">E${item.episode_no}</span>
                            </div>
                            <div class="file-path" title="${item.savepath}/${item.filename}">
                                <i class="fa fa-folder-open-o"></i> ${item.filename}
                            </div>
                        </div>

                        <!-- Right: Date & Actions -->
                        <div class="episode-right-col">
                            <div class="date-info">${dateHtml}</div>
                            <div class="episode-actions">
                                <button data-content_code="${item.content_code}" class="btn-minimal btn-request">
                                    <i class="fa fa-search"></i> 작품보기
                                </button>
                                <button data-title="${item.title}" class="btn-minimal btn-self-search">
                                    <i class="fa fa-list"></i> 목록검색
                                </button>
                                <button data-id="${item.id}" class="btn-minimal btn-json">
                                    <i class="fa fa-code"></i> JSON
                                </button>
                                <button data-id="${item.id}" class="btn-minimal btn-remove btn-remove-alt">
                                    <i class="fa fa-trash"></i> 삭제
                                </button>
                                ${item.status == 'completed' ? `<button data-path="${item.savepath}/${item.filename}" class="btn-minimal btn-watch btn-watch-primary"><i class="fa fa-play"></i> 보기</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }
            document.getElementById("list_div").innerHTML = str;
        }


    </script>

<style>
    /* Pagination & Modal Fixes */
    .btn-toolbar { justify-content: center; margin: 20px 0; }
    #page1 .btn-group .btn, #page2 .btn-group .btn {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #94a3b8; padding: 6px 14px; margin: 0 2px; border-radius: 6px;
    }
    #page1 .btn-group .btn[disabled], #page2 .btn-group .btn[disabled] {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-color: transparent;
    }
    
    .modal-dialog { max-width: 95% !important; width: 900px !important; margin: 10px auto; }
    .modal-body pre { background: #000 !important; color: #4ade80 !important; padding: 15px !important; border-radius: 8px !important; max-height: 70vh !important; font-size: 12px !important; }

    /* Video Player Enhancements */
    .playlist-controls {
        padding: 16px;
        background: linear-gradient(to bottom, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 1));
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }
    
    .playlist-header {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .playing-info { flex: 1; min-width: 0; }
    .video-title { 
        color: #fbbf24; font-weight: 700; font-size: 15px; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .progress-text { color: #94a3b8; font-size: 12px; margin-top: 2px; }
    
    .nav-btn, .action-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
        cursor: pointer;
    }
    .nav-btn:hover, .action-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
    .action-btn.active { background: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

    .playlist-drawer {
        display: none;
        margin-top: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 10px;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .playlist-grid { display: flex; flex-direction: column; gap: 4px; }
    .playlist-item {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        display: flex; align-items: center; gap: 12px;
        cursor: pointer; transition: all 0.2s;
        font-size: 13px; color: #cbd5e1;
    }
    .playlist-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(5px); }
    .playlist-item.active { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; }
    .playlist-item .ep-num { font-weight: 800; color: #fbbf24; min-width: 30px; }

    /* Zoom Button overlay */
    .video-zoom-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
        width: 38px; height: 38px;
        border-radius: 10px;
        opacity: 0; transition: opacity 0.3s;
        display: flex; align-items: center; justify-content: center;
    }
    .video-container:hover .video-zoom-btn { opacity: 1; }
    .video-zoom-btn.active { background: #3b82f6; border-color: transparent; }

    /* Video.js skin overrides */
    .video-js.vjs-theme-fantasy .vjs-big-play-button {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%) !important;
        border: none !important;
        width: 90px !important; height: 90px !important;
        line-height: 90px !important;
        border-radius: 50% !important;
        box-shadow: 0 0 30px rgba(37, 99, 235, 0.6) !important;
        transition: all 0.3s ease !important;
    }
    .video-js.vjs-theme-fantasy .vjs-big-play-button .vjs-icon-placeholder:before {
        font-size: 60px !important;
        line-height: 90px !important;
    }
    .video-js .vjs-control-bar { background: rgba(15, 23, 42, 0.8) !important; backdrop-filter: blur(10px) !important; }

    @media (max-width: 768px) {
        #videoModal .modal-dialog { width: 100% !important; margin: 0 !important; }
        #videoModal .modal-content { border-radius: 0 !important; height: 100vh; display: flex; flex-direction: column; }
        #video-player { max-height: 100vh !important; height: 100% !important; }
        .video-container { flex: 1; display: flex; align-items: center; }
        .playlist-controls { padding-bottom: 25px; } /* Mobile safe area */
        .video-zoom-btn { opacity: 0.8; top: 10px; right: 10px; }
    }

    @media (max-width: 768px) {
        #videoModal .modal-dialog { width: 100% !important; margin: 5px !important; }
        .episode-actions { grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .episode-card { padding: 10px; }
        .episode-thumb { width: 50px; height: 70px; }
    }

    /* External Players Section */
    .external-players {
        padding: 8px 16px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .external-players-grid {
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        gap: 10px;
    }
    .ext-player-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background: rgba(59, 130, 246, 0.12);
        border: 1px solid rgba(59, 130, 246, 0.25);
        border-radius: 10px;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .ext-player-btn:hover {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .ext-player-btn img {
        width: 28px;
        height: 28px;
        object-fit: contain;
    }
    @media (max-width: 768px) {
        .external-players-grid {
            gap: 6px;
        }
        .ext-player-btn {
            padding: 6px 10px;
            font-size: 12px;
        }
    }

    /* Episode Selector Row (Alist Style) */
    .episode-selector-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Episode Dropdown */
    .episode-dropdown-wrapper {
        position: relative;
        flex: 1;
    }
    .episode-dropdown {
        width: 100%;
        padding: 10px 40px 10px 14px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }
    .episode-dropdown:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
    }
    .episode-dropdown:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
    }
    .episode-dropdown option {
        background: #1e293b;
        color: #f1f5f9;
        padding: 10px;
    }
    .dropdown-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: white;
        pointer-events: none;
    }
    
    /* Auto-Next Toggle Switch */
    .auto-next-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
    }
    .auto-next-toggle input {
        display: none;
    }
    .toggle-label {
        font-size: 13px;
        color: #94a3b8;
        font-weight: 500;
        transition: color 0.2s;
    }
    .auto-next-toggle input:checked ~ .toggle-label {
        color: #f1f5f9;
    }
    .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: #334155;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .auto-next-toggle input:checked ~ .toggle-switch {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .auto-next-toggle input:checked ~ .toggle-switch::after {
        left: 22px;
    }
    
    @media (max-width: 768px) {
        .episode-selector-row {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        .episode-dropdown-wrapper {
            max-width: none;
        }
        .auto-next-toggle {
            justify-content: flex-end;
        }
    }
</style>

{% endblock %}