{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('.static', filename='css/mobile_custom.css') }}"/>
<link rel="stylesheet" href="{{ url_for('.static', filename='css/' ~ arg['sub'] ~ '.css') }}"/>

<div id="anilife_setting_wrapper" class="container-fluid mt-4 mx-auto content-cloak" style="max-width: 100%;">
  
  <div class="glass-card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white font-weight-bold"><i class="bi bi-gear-fill mr-2"></i>Anilife 설정</h2>
        {{ macros.m_button_group([['globalSettingSaveBtn', '설정 저장']])}}
    </div>

    {{ macros.m_row_start('5') }}
    {{ macros.m_row_end() }}
    
    <nav>
      {{ macros.m_tab_head_start() }}
        {{ macros.m_tab_head('normal', '일반', true) }}
        {{ macros.m_tab_head('auto', '홈화면 자동', false) }}
        {{ macros.m_tab_head('action', '기타', false) }}
      {{ macros.m_tab_head_end() }}
    </nav>
    
    <form id="setting" class="mt-4">
    <div class="tab-content" id="nav-tabContent">
    {{ macros.m_tab_content_start('normal', true) }}
      {{ macros.setting_input_text_and_buttons('anilife_url', '애니라이프 URL', [['go_btn', 'GO']], value=arg['anilife_url']) }}
      {{ macros.setting_input_text('anilife_proxy_url', '프록시 URL', col='4', value=arg.get('anilife_proxy_url', ''), desc='차단 시 프록시 서버를 입력하세요. 예: http://IP:PORT') }}
      {{ macros.setting_input_int('anilife_cache_ttl', 'HTTP 캐시 TTL (초)', value=arg.get('anilife_cache_ttl', 300), desc='HTTP 응답 캐시 유지 시간 (초 단위, 기본: 300초 = 5분)') }}
      
      <!-- 저장 폴더 (탐색 버튼 포함) -->
      <div class="row" style="padding-top: 10px; padding-bottom:10px; align-items: center;">
        <div class="col-sm-3 set-left">
          <strong>저장 폴더</strong>
        </div>
        <div class="col-sm-9">
          <div class="input-group col-sm-9">
            <input type="text" class="form-control form-control-sm" id="anilife_download_path" name="anilife_download_path" value="{{arg['anilife_download_path']}}">
            <div class="btn-group btn-group-sm flex-wrap mr-2" role="group" style="padding-left:5px; padding-top:0px">
              <button type="button" class="btn btn-sm btn-outline-primary" id="browse_folder_btn" title="폴더 탐색">
                <i class="bi bi-folder2-open"></i> 탐색
              </button>
            </div>
          </div>
          <div style="padding-left:20px; padding-top:5px;">
            <em>정상적으로 다운 완료 된 파일이 이동할 폴더 입니다.</em>
          </div>
        </div>
      </div>
      
      {{ macros.setting_input_int('anilife_max_ffmpeg_process_count', '동시 다운로드 수', value=arg['anilife_max_ffmpeg_process_count'], desc='동시에 다운로드 할 에피소드 갯수입니다.') }}
      {{ macros.setting_select('anilife_download_method', '다운로드 방법', [['ffmpeg', 'ffmpeg (기본)'], ['ytdlp', 'yt-dlp (단일쓰레드)'], ['aria2c', 'yt-dlp (멀티쓰레드/aria2c)']], value=arg.get('anilife_download_method', 'ffmpeg'), desc='m3u8 다운로드에 사용할 도구를 선택합니다.') }}
      <div id="anilife_download_threads_div">
        {{ macros.setting_select('anilife_download_threads', '다운로드 속도', [['1', '1배속 (1개, 안정)'], ['2', '2배속 (2개, 권장)'], ['4', '4배속 (4개)'], ['8', '8배속 (8개)'], ['16', '16배속 (16개, 빠름)']], value=arg.get('anilife_download_threads', '16'), desc='yt-dlp 모드에서 사용할 동시 다운로드 수입니다.') }}
      </div>
      {{ macros.setting_checkbox('anilife_order_desc', '요청 화면 최신순 정렬', value=arg['anilife_order_desc'], desc='On : 최신화부터, Off : 1화부터') }}
      {{ macros.setting_checkbox('anilife_auto_make_folder', '제목 폴더 생성', value=arg['anilife_auto_make_folder'], desc='제목으로 폴더를 생성하고 폴더 안에 다운로드합니다.') }}
      <div id="anilife_auto_make_folder_div" class="collapse pl-4 border-left ml-3" style="border-color: rgba(255,255,255,0.1) !important;">
        {{ macros.setting_input_text('anilife_finished_insert', '완결 표시', col='3', value=arg['anilife_finished_insert'], desc=['완결된 컨텐츠 폴더명 앞에 넣을 문구입니다.']) }}
        {{ macros.setting_checkbox('anilife_auto_make_season_folder', '시즌 폴더 생성', value=arg['anilife_auto_make_season_folder'], desc=['On : Season 번호 폴더를 만듭니다.']) }}
      </div>
        {{ macros.setting_checkbox('anilife_uncompleted_auto_enqueue', '자동으로 다시 받기', value=arg['anilife_uncompleted_auto_enqueue'], desc=['On : 플러그인 로딩시 미완료인 항목은 자동으로 다시 받습니다.']) }}
      {{ macros.setting_select('anilife_cache_minutes', 'HTML 캐시 시간', [['0', '캐시 없음'], ['5', '5분'], ['10', '10분'], ['15', '15분'], ['30', '30분'], ['60', '1시간']], value=arg.get('anilife_cache_minutes', '5'), desc=['브라우징(요청, 검색) 페이지의 HTML을 캐시합니다.', '0으로 설정하면 캐시를 사용하지 않습니다.']) }}
    {{ macros.m_tab_content_end() }}

    {{ macros.m_tab_content_start('auto', false) }}
      {{ macros.global_setting_scheduler_button(arg['scheduler'], arg['is_running']) }}
      {{ macros.setting_input_text('anilife_interval', '스케쥴링 실행 정보', value=arg['anilife_interval'], col='3', desc=['Inverval(minute 단위)이나 Cron 설정']) }}
      {{ macros.setting_checkbox('anilife_auto_start', '시작시 자동실행', value=arg['anilife_auto_start'], desc='On : 시작시 자동으로 스케쥴러에 등록됩니다.') }}
      {{ macros.setting_input_textarea('anilife_auto_code_list', '자동 다운로드할 작품 코드', desc=['all 입력시 모두 받기', '구분자 | 또는 엔터'], value=arg['anilife_auto_code_list'], row='10') }}
      {{ macros.setting_checkbox('anilife_auto_mode_all', '에피소드 모두 받기', value=arg['anilife_auto_mode_all'], desc=['On : 이전 에피소드를 모두 받습니다.', 'Off : 최신 에피소드만 받습니다.']) }}
    {{ macros.m_tab_content_end() }}

    {{ macros.m_tab_content_start('action', false) }}
      <div class="p-3" style="background: rgba(0,0,0,0.2); border-radius: 8px;">
          <h5 class="text-info mb-3"><i class="bi bi-lightning-charge-fill mr-2"></i>Actions</h5>
          {{ macros.setting_buttons([['global_one_execute_btn', '1회 실행']], left='1회 실행' ) }}
          <hr style="border-color: rgba(255,255,255,0.1);">
          {{ macros.setting_buttons([['global_reset_db_btn', 'DB 초기화']], left='DB정리' ) }}
          <hr style="border-color: rgba(255,255,255,0.1);">
          
          <h5 class="text-info mb-3"><i class="bi bi-cpu-fill mr-2"></i>시스템 상태 및 의존성</h5>
          <div id="system_check_result" class="mb-3 p-3 rounded" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
            <div class="d-flex align-items-center mb-2">
              <span class="mr-2">Chromium/Chrome:</span>
              <span id="browser_status_badge" class="badge badge-secondary">확인 중...</span>
            </div>
            <div id="browser_path_display" class="small text-muted mb-2" style="font-family: monospace;"></div>
            <div id="install_guide_section" style="display:none;">
              <p class="small text-warning mb-2"><i class="bi bi-exclamation-triangle-fill mr-1"></i>브라우저가 발견되지 않았습니다. Zendriver 기능을 위해 설치가 필요합니다.</p>
              <div id="auto_install_div" style="display:none;">
                <button type="button" id="auto_install_btn" class="btn btn-sm btn-outline-info mb-2">
                  <i class="bi bi-download mr-1"></i>자동 설치 (Ubuntu/Docker)
                </button>
              </div>
              <div class="mt-2">
                <small class="d-block text-muted mb-1">수동 설치 명령어:</small>
                <div class="input-group input-group-sm">
                  <input type="text" id="manual_install_cmd" class="form-control form-control-sm bg-dark border-secondary text-info" readonly value="apt-get update && apt-get install -y chromium-browser">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="copy_cmd_btn"><i class="bi bi-clipboard"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <hr style="border-color: rgba(255,255,255,0.1);">
          <h5 class="text-info mb-3"><i class="bi bi-browser-chrome mr-2"></i>Zendriver 설정</h5>
          {{ macros.setting_input_text('anilife_zendriver_browser_path', '브라우저 경로', value=arg.get('anilife_zendriver_browser_path', ''), desc=['Zendriver가 사용할 Chrome/Chromium 실행 파일 경로입니다.', '위의 시스템 상태에서 자동으로 찾은 경우 비워두셔도 됩니다 (수동 설정 시 우선 적용).']) }}
      </div>
    {{ macros.m_tab_content_end() }}

    </div><!--tab-content-->
    </form>
  </div>
</div> <!--전체-->

<!-- 폴더 탐색 모달 -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" role="dialog" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1);">
      <div class="modal-header" style="border-color: rgba(255,255,255,0.1);">
        <h5 class="modal-title text-white" id="folderBrowserModalLabel">
          <i class="bi bi-folder2-open mr-2"></i>폴더 선택
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <button type="button" class="btn btn-sm btn-outline-secondary mr-2" id="folder_go_up" title="상위 폴더">
            <i class="bi bi-arrow-up"></i>
          </button>
          <div class="flex-grow-1 px-3 py-2 rounded" style="background: rgba(0,0,0,0.3); font-family: monospace; color: #94a3b8;">
            <span id="current_path_display">/</span>
          </div>
        </div>
        <div id="folder_list" style="min-height: 300px; max-height: 600px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px;">
          <div class="text-center text-muted py-4">
            <i class="bi bi-arrow-repeat spin"></i> 로딩 중...
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border-color: rgba(255,255,255,0.1);">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="folder_select_btn">
          <i class="bi bi-check-lg mr-1"></i>선택
        </button>
      </div>
    </div>
  </div>
</div>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

<style>
    /* Global Background */
    body {
        font-family: 'NamumSquareNeo', system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Noto Sans, Liberation Sans, Arial, sans-serif;
        background-image: linear-gradient(135deg, #1f2937, #111827, #0f172a);
        color: #e2e8f0;
        min-height: 100vh;
    }

    /* Glass Card Container */
    .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Tabs Styling */
    .nav-tabs {
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-tabs .nav-link {
        color: #94a3b8;
        border: none;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
    }
    
    .nav-tabs .nav-link:hover {
        color: #e2e8f0;
        background: rgba(255, 255, 255, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: #60a5fa !important;
        background: rgba(30, 41, 59, 0.8) !important;
        border-bottom: 2px solid #60a5fa !important;
    }

    /* Navigation Menu Override (Top Sub-menu) */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important; /* Pill shape container */
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important; /* Fit content */
        flex-wrap: wrap; /* allow wrap on small screens */
        justify-content: center;
        width: auto !important; /* Prevent full width */
        margin-bottom: 20px;
    }

    ul.nav.nav-pills .nav-item {
        margin: 0 2px;
    }

    ul.nav.nav-pills .nav-link {
        border-radius: 50rem !important;
        padding: 8px 20px !important;
        color: #94a3b8 !important; /* Muted text */
        font-weight: 600;
        transition: all 0.3s ease;
    }

    ul.nav.nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff !important;
        transform: translateY(-1px);
    }

    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    /* Form Controls */
    .form-control, .custom-select, textarea {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #f1f5f9 !important;
        border-radius: 8px !important;
    }
    
    .form-control:focus, .custom-select:focus, textarea:focus {
        background-color: rgba(0, 0, 0, 0.5) !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25) !important;
    }

    /* Labels & Text */
    label, .col-form-label {
        font-weight: 600;
        color: #cbd5e1;
    }
    
    .text-muted {
        color: #94a3b8 !important;
    }

    /* Buttons */
    .btn {
        border: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 8px 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-primary, #globalSettingSaveBtn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:hover, #globalSettingSaveBtn:hover {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
    }
    
    /* GO Button specific (Input Group) */
    #go_btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        border-radius: 0 8px 8px 0 !important; /* Fix for input group */
        margin-left: -1px;
    }
    
    #go_btn:hover {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        z-index: 5;
    }

    .btn-outline-primary {
        color: #60a5fa;
        border: 1px solid #60a5fa;
        background: transparent;
    }
    
    .btn-outline-primary:hover {
        background: rgba(96, 165, 250, 0.1);
        color: #93c5fd;
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
    }
    
    .btn:active {
        transform: translateY(0) !important;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
    }

    /* Custom Checkbox/Switch Override (if Bootstrap switch is used) */
    .custom-control-label::before {
        background-color: rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.2);
    }
    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    /* Collapse Borders */
    /* Folder Browser Modal Styles */
    .folder-item {
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex !important;
        align-items: center;
        width: 100%;
        overflow: hidden;
    }
    .folder-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    .folder-item span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }
    .folder-item.selected {
        background: rgba(59, 130, 246, 0.3) !important;
    }
    
</style>


<script type="text/javascript">
var package_name = "{{arg['package_name'] }}";
var sub = "{{arg['sub'] }}";
var current_data = null;


$(document).ready(function(){
  // Width Fix
  $("#main_container").removeClass("container").addClass("container-fluid");
  
  use_collapse('anilife_auto_make_folder');
});

$('#ani365_auto_make_folder').change(function() {
  use_collapse('anilife_auto_make_folder');
});

function toggle_download_threads() {
  var method = $('#anilife_download_method').val();
  if (method == 'ytdlp' || method == 'aria2c') {
    $('#anilife_download_threads_div').slideDown();
  } else {
    $('#anilife_download_threads_div').slideUp();
  }
}

$('#anilife_download_method').change(function() {
  toggle_download_threads();
});

// Initial check
toggle_download_threads();


$("body").on('click', '#go_btn', function(e){
  e.preventDefault();
  let url = document.getElementById("anilife_url").value
  window.open(url, "_blank");
});

// ======================================
// 폴더 탐색 기능
// ======================================
var currentBrowsePath = '';
var parentPath = null;

$('#browse_folder_btn').on('click', function() {
  var initialPath = $('#anilife_download_path').val() || '';
  loadFolderList(initialPath);
  $('#folderBrowserModal').modal('show');
});

function loadFolderList(path) {
  $('#folder_list').html('<div class="text-center text-muted py-4"><i class="bi bi-arrow-repeat"></i> 로딩 중...</div>');
  
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/browse_dir',
    type: 'POST',
    data: { path: path },
    dataType: 'json',
    success: function(ret) {
      if (ret.ret === 'success') {
        currentBrowsePath = ret.current_path;
        parentPath = ret.parent_path;
        $('#current_path_display').text(currentBrowsePath);
        $('#folder_go_up').prop('disabled', !parentPath);
        
        var html = '';
        if (parentPath) {
          html += '<div class="folder-item folder-parent d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(parentPath) + '" style="cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);">';
          html += '<i class="bi bi-folder-symlink text-info mr-2"></i><span class="text-light">..</span><span class="text-muted ml-2">(상위 폴더)</span></div>';
        }
        html += '<div class="folder-item folder-current d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(currentBrowsePath) + '" style="cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);">';
        html += '<i class="bi bi-folder-check text-success mr-2"></i><span class="text-light">.</span><span class="text-muted ml-2">(현재 폴더)</span></div>';
        
        if (ret.directories.length === 0) {
          html += '<div class="text-center text-muted py-3"><small>하위 폴더 없음</small></div>';
        } else {
          for (var i = 0; i < ret.directories.length; i++) {
            var dir = ret.directories[i];
            html += '<div class="folder-item d-flex align-items-center p-2 rounded" data-path="' + escapeHtml(dir.path) + '" style="cursor: pointer;">';
            html += '<i class="bi bi-folder-fill text-warning mr-2"></i><span class="text-light">' + escapeHtml(dir.name) + '</span></div>';
          }
        }
        $('#folder_list').html(html);
      } else {
        $('#folder_list').html('<div class="text-center text-danger py-4">로드 실패: ' + (ret.error || '알 수 없는 오류') + '</div>');
      }
    },
    error: function(xhr, status, error) {
      $('#folder_list').html('<div class="text-center text-danger py-4">에러: ' + error + '</div>');
    }
  });
}

$('#folder_list').on('dblclick', '.folder-item', function() { loadFolderList($(this).data('path')); });
$('#folder_list').on('click', '.folder-item', function() {
  $('.folder-item').removeClass('selected').css('background', '');
  $(this).addClass('selected').css('background', 'rgba(59, 130, 246, 0.3)');
  currentBrowsePath = $(this).data('path');
  $('#current_path_display').text(currentBrowsePath);
});
$('#folder_go_up').on('click', function() { if (parentPath) loadFolderList(parentPath); });
$('#folder_select_btn').on('click', function() {
  $('#anilife_download_path').val(currentBrowsePath);
  $('#folderBrowserModal').modal('hide');
  $.notify('저장 폴더가 설정되었습니다: ' + currentBrowsePath, {type: 'success'});
});
function escapeHtml(text) { var div = document.createElement('div'); div.appendChild(document.createTextNode(text)); return div.innerHTML; }

// ======================================
// 1회 실행 버튼
// ======================================
$("body").on('click', '#global_one_execute_btn', function(e){
  e.preventDefault();
  $.ajax({
    url: '/'+package_name+'/ajax/'+sub+'/immediately_execute',
    type: "POST",
    cache: false,
    dataType: "json",
    success: function(ret) {
      if (ret.ret == 'success') {
        $.notify('스케줄러 1회 실행을 시작합니다.', {type:'success'});
      } else {
        $.notify(ret.msg || '실행 실패', {type:'danger'});
      }
    },
    error: function(xhr, status, error) {
      $.notify('에러: ' + error, {type:'danger'});
    }
  });
});

// ======================================
// DB 초기화 버튼
// ======================================
$("body").on('click', '#global_reset_db_btn', function(e){
  e.preventDefault();
  if (!confirm('정말 DB를 초기화하시겠습니까?')) return;
  $.ajax({
    url: '/'+package_name+'/ajax/'+sub+'/reset_db',
    type: "POST",
    cache: false,
    dataType: "json",
    success: function(ret) {
      if (ret.ret == 'success') {
        $.notify('DB가 초기화되었습니다.', {type:'success'});
      } else {
        $.notify(ret.msg || '초기화 실패', {type:'danger'});
      }
    },
    error: function(xhr, status, error) {
      $.notify('에러: ' + error, {type:'danger'});
    }
  });
});

// ======================================
// 시스템 체크 및 브라우저 설치
// ======================================
function runSystemCheck() {
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/system_check',
    type: 'POST',
    success: function(ret) {
      if (ret.browser_found) {
        $('#browser_status_badge').removeClass('badge-secondary badge-danger badge-warning').addClass('badge-success').text('발견됨');
        $('#browser_path_display').text('경로: ' + ret.browser_path);
        $('#install_guide_section').hide();
      } else {
        if (ret.snap_error) {
          $('#browser_status_badge').removeClass('badge-secondary badge-success badge-danger').addClass('badge-warning').text('스냅 오류');
          $('#browser_path_display').html('<span class="text-warning">발견되었으나 Snap 버전입니다. 도커에서 작동하지 않습니다.</span>');
        } else {
          $('#browser_status_badge').removeClass('badge-secondary badge-success badge-warning').addClass('badge-danger').text('미설치');
          $('#browser_path_display').text('');
        }
        $('#install_guide_section').show();
        $('#manual_install_cmd').val(ret.install_cmd);
        if (ret.can_install) {
          $('#auto_install_div').show();
        } else {
          $('#auto_install_div').hide();
        }
      }
    }
  });
}

// 자동 설치 버튼
$('#auto_install_btn').on('click', function() {
  if (!confirm('시스템 브라우저 설치를 시작하시겠습니까?\n(Ubuntu/Debian 기반 도커 환경에서만 작동합니다)')) return;
  
  var btn = $(this);
  btn.prop('disabled', true).html('<i class="bi bi-arrow-repeat spin mr-1"></i>설치 중 (최대 10분 소요)...');
  
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/install_browser',
    type: 'POST',
    success: function(ret) {
      if (ret.ret === 'success') {
        $.notify(ret.msg, {type: 'success'});
        if (ret.path) {
          $('#anilife_zendriver_browser_path').val(ret.path);
        }
        runSystemCheck();
      } else {
        $.notify(ret.msg, {type: 'danger'});
      }
    },
    error: function() {
      $.notify('설치 요청 중 오류가 발생했습니다.', {type: 'danger'});
    },
    complete: function() {
      btn.prop('disabled', false).html('<i class="bi bi-download mr-1"></i>자동 설치 (Ubuntu/Docker)');
    }
  });
});

// 명령어 복사 버튼
$('#copy_cmd_btn').on('click', function() {
  var copyText = document.getElementById("manual_install_cmd");
  copyText.select();
  copyText.setSelectionRange(0, 99999);
  document.execCommand("copy");
  $.notify('명령어가 복사되었습니다.', {type: 'info'});
});

// 초기 실행 - Action 탭 로드시 시스템 체크
$(document).ready(function() {
  runSystemCheck();
});

</script>

<style>
    /* Smooth Load Transition */
    .content-cloak, 
    #menu_module_div, 
    #menu_page_div {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }
    
    /* Staggered Delays for Natural Top-Down Flow */
    #menu_module_div.visible {
        opacity: 1;
        transition-delay: 0ms;
    }

    #menu_page_div.visible {
        opacity: 1;
        transition-delay: 150ms;
    }

    .content-cloak.visible {
        opacity: 1;
        transition-delay: 300ms;
    }
    
    /* Navigation Menu Override (Top Sub-menu) */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important;
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important;
        flex-wrap: wrap;
        justify-content: center;
        width: auto !important;
        margin-bottom: 20px;
    }

    ul.nav.nav-pills .nav-item { margin: 0 2px; }
    ul.nav.nav-pills .nav-link {
        border-radius: 50rem !important;
        padding: 8px 20px !important;
        color: #94a3b8 !important;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    ul.nav.nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff !important;
        transform: translateY(-1px);
    }
    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
</style>

<script type="text/javascript">
$(document).ready(function(){
  // Smooth Load Trigger
  setTimeout(function() {
      $('.content-cloak, #menu_module_div, #menu_page_div').addClass('visible');
  }, 100);
});
</script>
{% endblock %}