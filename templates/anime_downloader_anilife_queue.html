{% extends "base.html" %}
{% block content %}

    <div class="content-cloak">
        <div class="d-flex justify-content-start align-items-center gap-2 mb-4">
            <button id="reset_btn" class="btn custom-btn btn-reset-queue"><i class="fa fa-refresh mr-2"></i> 초기화</button>
            <button id="delete_completed_btn" class="btn custom-btn btn-delete-completed"><i class="fa fa-trash-o mr-2"></i> 완료 목록 삭제</button>
            <button id="go_ffmpeg_btn" class="btn custom-btn btn-ffmpeg"><i class="fa fa-film mr-2"></i> Go FFMPEG</button>
        </div>
    </div>
    <div id='page1'></div>
    <!-- Desktop Table View -->
    <div class="table-responsive d-none d-md-block">
        <table id="result_table" class="table table-sm tableRowHover">
            <thead class="thead-dark">
            <tr>
                <th style="width:5%; text-align:center;">IDX</th>
                <th style="width:8%; text-align:center;">Plugin</th>
                <th style="width:10%; text-align:center;">시작시간</th>
                <th style="width:20%; text-align:center;">파일명</th>
                <th style="width:8%; text-align:center;">상태</th>
                <th style="width:15%; text-align:center;">진행률</th>
                <th style="width:5%; text-align:center;">길이</th>
                <th style="width:5%; text-align:center;">PF</th>
                <th style="width:8%; text-align:center;">배속</th>
                <th style="width:8%; text-align:center;">진행시간</th>
                <th style="width:8%; text-align:center;">Action</th>
            </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div id="list_mobile" class="d-md-none"></div>

    <div id='page2'></div>

    <script type="text/javascript">
        const package_name = "{{arg['package_name'] }}";
        const sub = "{{arg['sub'] }}";

        function on_start(silent = false) {
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/entity_list',
                type: "POST",
                cache: false,
                data: {},
                dataType: "json",
                global: !silent,
                success: function (data) {
                    current_data = data;
                    
                    const list_body = $("#list");
                    const list_mobile = $("#list_mobile");
                    
                    if (data.length == 0) {
                        list_body.html("<tr><td colspan='11'><h4>작업이 없습니다.</h4><td><tr>");
                        list_mobile.html("<div class='text-center p-5'><h4>작업이 없습니다.</h4></div>");
                    } else {
                        // Table View update
                        if (list_body.children().length !== data.length * 2) {
                            var str_table = '';
                            for (i in data) str_table += make_item(data[i]);
                            list_body.html(str_table);
                        }
                        
                        // Mobile Card View update
                        if (list_mobile.children().length !== data.length) {
                            var str_mobile = '';
                            for (i in data) str_mobile += make_item_mobile(data[i]);
                            list_mobile.html(str_mobile);
                        }
                        
                        // Status updates for both
                        for (i in data) {
                            status_html(data[i]);
                        }
                    }
                }
            });
        }

        $(document).ready(function () {
            const socket_url = window.location.protocol + "//" + document.domain + ":" + location.port + "/anime_downloader/anilife/queue";
            // console.log("Connecting to socket:", socket_url);
            const socket = io.connect(socket_url);

            socket.on('connect', function() {
                // console.log('Socket connected to anilife queue!');
            });
            
            // 모든 이벤트 모니터링 (디버깅용)
            socket.onAny((event, ...args) => {
                // console.log(`[Socket event: ${event}]`, args);
            });

            socket.on('start', function (data) {
                on_start();
            });
            
            socket.on('list_refresh', function (data) {
                on_start()
            });

            // 3초마다 자동 새로고침 폴백 (인디케이터 없이 조용히)
            setInterval(function() {
                on_start(true);
            }, 3000);

            socket.on('status', function (data) {
                // console.log("Status update received:", data);
                status_html(data);
            });

            socket.on('on_start', function (data) {
                document.getElementById("log").innerHTML += data.data;
                document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
                document.getElementById("log").style.visibility = 'visible';
                $('#loading').hide();
            });

            socket.on('add', function (data) {
                if (current_data == null || current_data.length == 0) {
                    current_data = Array();
                    $("#list").html(make_item(data));
                    $("#list_mobile").html(make_item_mobile(data));
                } else {
                    $("#list").append(make_item(data));
                    $("#list_mobile").append(make_item_mobile(data));
                }
                current_data.push(data);
            });

            socket.on('status_change', function (data) {
                button_html(data);
            });

            socket.on('last', function (data) {
                status_html(data);
                button_html(data);
            });

            globalSendCommand('list', null, null, null, function (data) {
                current_data = data;
                $("#list").html('');
                $("#list_mobile").html('');
                if (data.length == 0) {
                    $("#list").html("<tr><td colspan='10'><h4>작업이 없습니다.</h4><td><tr>");
                    $("#list_mobile").html("<div class='text-center p-5'><h4>작업이 없습니다.</h4></div>");
                } else {
                    var str_table = '';
                    var str_mobile = '';
                    for (i in data) {
                        str_table += make_item(data[i]);
                        str_mobile += make_item_mobile(data[i]);
                    }
                    $("#list").html(str_table);
                    $("#list_mobile").html(str_mobile);
                }
            });


        });


        $("body").on('click', '#stop_btn', function (e) {
            e.stopPropagation();
            e.preventDefault();
            var idx = $(this).data('idx');
            globalSendCommand('stop', idx, null, null, function (ret) {
                // refresh_item is legacy, on_start will handle it or socket will
            });
        });


        function make_item_mobile(data) {
            var str = '';
            str += '<div class="queue-card mb-3" id="card_' + data.idx + '">';
            str += '  <div class="card-header-flex">';
            str += '    <span class="card-idx">#' + data.idx + '</span>';
            str += '    <span id="card_status_kor_' + data.idx + '" class="status-badge status-' + data.status_str.toLowerCase() + '">' + data.status_kor + '</span>';
            str += '  </div>';
            str += '  <div class="card-content">';
            str += '    <div class="card-filename">' + data.filename + '</div>';
            str += '    <div class="progress mt-3 mb-2" style="height: 10px;">';
            str += '      <div id="card_progress_bar_' + data.idx + '" class="progress-bar" style="width:' + data.percent + '%;"></div>';
            str += '    </div>';
            str += '    <div class="card-meta">';
            str += '      <div class="meta-item"><i class="fa fa-clock-o"></i> <span id="card_download_time_' + data.idx + '">' + data.download_time + '</span></div>';
            str += '      <div class="meta-item"><i class="fa fa-bolt"></i> <span id="card_current_speed_' + data.idx + '">' + data.current_speed + '</span></div>';
            str += '      <div class="meta-item"><i class="fa fa-exclamation-triangle"></i> <span id="card_current_pf_count_' + data.idx + '">' + data.current_pf_count + '</span></div>';
            str += '    </div>';
            str += '  </div>';
            str += '  <div id="card_button_' + data.idx + '" class="card-footer-actions">';
            if (data.status_str == 'DOWNLOADING') {
                str += '    <button id="stop_btn" class="action-btn btn-stop w-100" data-idx="' + data.idx + '"><i class="fa fa-stop mr-1"></i> 서비스 중지</button>';
            }
            str += '  </div>';
            str += '</div>';
            return str;
        }

        function make_item(data) {
            str = '<tr id="tr1_' + data.idx + '" style="cursor: pointer;" data-toggle="collapse" data-target="#collapse_' + data.idx + '" aria-expanded="true" >';
            str += make_item1(data);
            str += '</tr>';
            str += '<tr class="collapse tableRowHoverOff" style="cursor: pointer;"  id="collapse_' + data.idx + '">';
            str += make_item2(data);
            str += '</tr>';
            return str;
        }

        function make_item1(data) {
            //console.log(data);
            str = '';
            str += '<td scope="col" style="width:5%; text-align:center;">' + data.idx + '</td>';
            str += '<td scope="col" style="width:8%; text-align:center;">' + data.callback_id + '</td>';
            str += '<td scope="col" style="width:10%; text-align:center;">' + data.start_time + '</td>';
            str += '<td scope="col" style="width:20%; text-align:center;">' + data.filename + '</td>';
            str += '<td id="status_' + data.idx + '" scope="col" style="width:8%; text-align:center;">' + data.status_kor + '</td>';
            var visi = 'hidden';
            if (parseInt(data.percent) > 0) {
                visi = 'visible';
            }
            str += '<td scope="col" style="width:20%; text-align:center;"><div class="progress"><div id="progress_' + data.idx + '" class="progress-bar" style="visibility: ' + visi + '; width:' + data.percent + '%">' + data.percent + '%</div></div></td>';
            str += '<td scope="col" style="width:5%; text-align:center;">' + data.duration_str + '</td>';
            str += '<td id="current_pf_count_' + data.idx + '" scope="col" style="width:5%; text-align:center;">' + data.current_pf_count + '</td>';
            str += '<td id="current_speed_' + data.idx + '" scope="col" style="width:8%; text-align:center;">' + data.current_speed + '</td>';
            str += '<td id="download_time_' + data.idx + '" scope="col" style="width:8%; text-align:center;">' + data.download_time + '</td>';
            str += '<td id="button_' + data.idx + '" scope="col" style="width:8%; text-align:center;">';
            if (data.status_str == 'DOWNLOADING') {
                str += j_button('stop_btn', '중지', {'idx': data.idx}, 'danger', false, false);
            }
            str += '</td>'
            return str;
        }

        function make_item2(data) {
            str = '';
            str += '<td colspan="11">';
            str += '<div id="detail_' + data.idx + '">';
            str += get_detail(data);
            str += '</div>';
            str += '</td>';
            return str
        }


        function get_detail(data) {
            var str = j_row_info('URL', data.url);
            str += j_row_info('임시경로', data.temp_fullpath);
            str += j_row_info('저장경로', data.save_fullpath);
            str += j_row_info('진행률(current/total)', data.percent + '% (' + data.current_duration + ' / ' + data.duration + ')');
            str += j_row_info('현재 비트레이트', data.current_bitrate);
            str += j_row_info('종료시간', data.end_time);
            str += j_row_info('허용 Packet Fail 수', data.max_pf_count);
            str += j_row_info('파일 Exist', data.exist);
            if (data.status_str == 'COMPLETED') {
                str += j_row_info('파일 크기', data.filesize_str);
                str += j_row_info('다운 속도', data.download_speed);
            }
            return str;
        }

        function button_html(data) {
            var btn_str = '';
            var btn_mobile_str = '';
            if (data.status_str == 'DOWNLOADING') {
                btn_str = '<button id="stop_btn" class="action-btn btn-stop" data-idx="' + data.idx + '"><i class="fa fa-stop mr-1"></i> 중지</button>';
                btn_mobile_str = '<button id="stop_btn" class="action-btn btn-stop w-100" data-idx="' + data.idx + '"><i class="fa fa-stop mr-1"></i> 서비스 중지</button>';
            }
            $("#button_" + data.idx).html(btn_str);
            $("#card_button_" + data.idx).html(btn_mobile_str);
        }

        function status_html(data) {
            // Table Update
            var progress = document.getElementById("progress_" + data.idx);
            if (progress) {
                progress.style.width = data.percent + '%';
                progress.innerHTML = data.percent + '%';
                progress.style.visibility = 'visible';
                document.getElementById("status_" + data.idx).innerHTML = data.status_kor;
                document.getElementById("current_pf_count_" + data.idx).innerHTML = data.current_pf_count;
                document.getElementById("current_speed_" + data.idx).innerHTML = data.current_speed;
                document.getElementById("download_time_" + data.idx).innerHTML = data.download_time;
                document.getElementById("detail_" + data.idx).innerHTML = get_detail(data);
                button_html(data);
            }

            // Mobile Card Update
            var card_progress = document.getElementById("card_progress_bar_" + data.idx);
            if (card_progress) {
                card_progress.style.width = data.percent + '%';
                var status_badge = document.getElementById("card_status_kor_" + data.idx);
                status_badge.innerHTML = data.status_kor;
                status_badge.className = 'status-badge status-' + data.status_str.toLowerCase();
                
                document.getElementById("card_download_time_" + data.idx).innerHTML = data.download_time;
                document.getElementById("card_current_speed_" + data.idx).innerHTML = data.current_speed;
                document.getElementById("card_current_pf_count_" + data.idx).innerHTML = data.current_pf_count;
                
                // Card Button Update
                var card_btn_container = document.getElementById("card_button_" + data.idx);
                if (data.status_str == 'DOWNLOADING') {
                    card_btn_container.innerHTML = '<button id="stop_btn" class="action-btn btn-stop w-100" data-idx="' + data.idx + '"><i class="fa fa-stop mr-1"></i> 서비스 중지</button>';
                } else {
                    card_btn_container.innerHTML = '';
                }
            }
        }

        $("body").on('click', '#reset_btn', function (e) {
            e.preventDefault();
            entity_id = $(this).data('id')
            send_data = {'command': 'reset', 'entity_id': -1}
            queue_command(send_data)
        });

        $("body").on('click', '#delete_completed_btn', function (e) {
            e.preventDefault();
            send_data = {'command': 'delete_completed', 'entity_id': -1}
            queue_command(send_data)
        });

        $("body").on('click', '#go_ffmpeg_btn', function (e) {
            e.preventDefault();
            window.location.href = '/ffmpeg/list';
        });

        function queue_command(data) {
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/queue_command',
                type: "POST",
                cache: false,
                data: data,
                dataType: "json",
                success: function (ret) {
                    if (ret.ret == 'notify') {
                        $.notify('<strong>' + ret.log + '</strong>', {type: 'warning'});
                    } else if (ret.ret == 'success' || ret == true) {
                        $.notify('명령을 완료했습니다.', {type: 'success'});
                    }
                    on_start();
                }
            });
        }

</script>
<style>
    /* ========== Cosmic Violet Theme (Anilife Exclusive) ========== */
    body {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 40%, #4c1d95 100%) !important;
        background-attachment: fixed;
        color: #e0e7ff;
        min-height: 100vh;
        font-family: 'Inter', 'Noto Sans KR', system-ui, sans-serif;
    }
    
    /* Table Styling for Violet Theme */
    .table {
        color: #e0e7ff !important;
        background: rgba(49, 46, 129, 0.4) !important;
        border-radius: 12px;
    }
    
    .table thead th, .thead-dark th {
        background: linear-gradient(135deg, rgba(76, 29, 149, 0.9) 0%, rgba(49, 46, 129, 0.9) 100%) !important;
        color: #c4b5fd !important;
        border-color: rgba(167, 139, 250, 0.2) !important;
    }
    
    .table tbody tr {
        background: rgba(30, 27, 75, 0.6) !important;
    }
    
    .table tbody tr:hover, .tableRowHover:hover {
        background: rgba(76, 29, 149, 0.5) !important;
    }
    
    .table td, .table th {
        border-color: rgba(167, 139, 250, 0.15) !important;
        color: #e0e7ff !important;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
        border: none !important;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        border: none !important;
    }

    /* Custom Premium Buttons */
    .custom-btn {
        padding: 8px 20px; border-radius: 12px; font-weight: 700; font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex; align-items: center; justify-content: center; color: white !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .btn-reset-queue { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3); }
    .btn-reset-queue:hover { background: rgba(59, 130, 246, 0.4); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3); }
    
    .btn-delete-completed { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.3); }
    .btn-delete-completed:hover { background: rgba(239, 68, 68, 0.4); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3); }
    
    .btn-ffmpeg { background: rgba(139, 92, 246, 0.2); border-color: rgba(139, 92, 246, 0.3); }
    .btn-ffmpeg:hover { background: rgba(139, 92, 246, 0.4); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3); }

    /* Action buttons inside table */
    .action-btn {
        padding: 4px 12px; border-radius: 50rem; font-size: 12px; font-weight: 700;
        transition: all 0.2s; border: 1px solid transparent; background: transparent; color: #94a3b8;
    }
    .btn-stop { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
    .btn-stop:hover { background: #ef4444; color: white; transform: scale(1.05); }

    /* Mobile Card Styles */
    .queue-card {
        background: rgba(30, 27, 75, 0.4);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(167, 139, 250, 0.15);
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .queue-card:hover { border-color: rgba(167, 139, 250, 0.4); transform: translateY(-3px); }
    
    .card-header-flex {
        padding: 12px 20px;
        background: rgba(49, 46, 129, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(167, 139, 250, 0.1);
    }
    .card-idx { font-weight: 800; color: #818cf8; font-size: 14px; }
    
    .card-content { padding: 20px; }
    .card-filename {
        font-size: 16px;
        font-weight: 700;
        color: #f8fafc;
        line-height: 1.4;
        word-break: break-all;
    }
    
    .card-meta {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .meta-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #94a3b8;
    }
    .meta-item i { font-size: 14px; color: #a78bfa; margin-bottom: 2px; }
    .meta-item span { color: #e2e8f0; font-weight: 600; font-size: 12px; }
    
    .card-footer-actions { padding: 0 20px 20px 20px; }
    
    .status-badge {
        font-size: 10px; font-weight: 800; padding: 4px 12px; border-radius: 50rem;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .status-completed { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-downloading { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-wait { background: rgba(148, 163, 184, 0.2); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }
    .status-fail { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    
    .progress {
        background: rgba(49, 46, 129, 0.6) !important;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%) !important;
    }

    /* 로딩 인디케이터 오버라이드 */
    #loading {
        background: rgba(30, 27, 75, 0.9) !important;
        backdrop-filter: blur(8px) !important;
    }
    
    #loading img,
    #loading svg {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
    }
    
    #loading::before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 4px solid rgba(96, 165, 250, 0.2);
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        z-index: 100001;
    }
    
    @keyframes spin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    #modal_loading img,
    #modal_loading svg {
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
    }
    
    #modal_loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 3px solid rgba(96, 165, 250, 0.2);
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    /* Navigation Menu Override (Top Sub-menu) */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important;
        padding: 6px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
        display: inline-flex !important;
        flex-wrap: wrap;
        justify-content: center;
        width: auto !important;
        margin-bottom: 20px;
        margin-top: 10px;
    }

    ul.nav.nav-pills .nav-item { margin: 2px; }
    ul.nav.nav-pills .nav-link {
        border-radius: 50rem !important;
        padding: 8px 20px !important;
        color: #94a3b8 !important;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    ul.nav.nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff !important;
        transform: translateY(-1px);
    }
    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    /* Mobile Logic Fix */
    @media (max-width: 768px) {
        body { 
            padding-top: 10px !important; 
        }
        ul.nav.nav-pills.bg-light {
            border-radius: 12px !important;
            width: 100% !important;
            display: flex !important;
            margin-top: 50px !important; /* Ensure visibility below SJVA navbar */
            margin-bottom: 10px !important;
        }
        ul.nav.nav-pills .nav-link {
            padding: 6px 12px !important;
            font-size: 13px;
        }
    }
</style>

<script type="text/javascript">
$(document).ready(function(){
  // Smooth Load Trigger
  setTimeout(function() {
      $('.content-cloak, #menu_module_div, #menu_page_div').addClass('visible');
  }, 100);
});
</script>
<style>
/* Mobile Margin Fix & Table Scrolling */
@media (max-width: 768px) {
    body { overflow-x: hidden !important; }
    #result_table { 
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .container, .container-fluid, .row, form, #program_list, #program_auto_form, #episode_list, .queue-container, #yommi_wrapper, #main_container {
        width: 100% !important; max-width: 100% !important;
        padding-left: 4px !important; padding-right: 4px !important;
        margin-left: 0 !important; margin-right: 0 !important;
        box-sizing: border-box !important;
    }
    .form-group, .form-inline, [class*="col-"] {
        flex: 0 0 100% !important; max-width: 100% !important; width: 100% !important;
        padding-left: 0 !important; padding-right: 0 !important;
    }
    .row { margin-left: 0 !important; margin-right: 0 !important; }
    .card, .card.p-4, .card.p-lg-5, .card.border-light {
         width: calc(100% - 8px) !important; max-width: 100% !important;
         padding: 8px !important; margin: 4px !important;
         border-radius: 12px !important; box-sizing: border-box !important;
    }
    .badge {
        white-space: normal !important; text-align: left !important;
        line-height: 1.4 !important; height: auto !important; display: inline-block !important;
    }
}
</style>
{% endblock %}
