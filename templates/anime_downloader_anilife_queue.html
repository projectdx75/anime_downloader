{% extends "base.html" %}
{% block content %}
    <link rel="stylesheet" href="{{ url_for('.static', filename='css/mobile_custom.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('.static', filename='css/' ~ arg['sub'] ~ '.css') }}"/>

    <div class="content-cloak">
        <div class="d-flex justify-content-start align-items-center gap-2 mb-4">
            <button id="reset_btn" class="btn custom-btn btn-reset-queue"><i class="fa fa-refresh mr-2"></i> 초기화</button>
            <button id="delete_completed_btn" class="btn custom-btn btn-delete-completed"><i class="fa fa-trash-o mr-2"></i> 완료 삭제</button>
            <button id="go_gdm_btn" class="btn custom-btn btn-gdm"><i class="fa fa-download mr-2"></i> Go GDM</button>
        </div>
    </div>
    
    <!-- Desktop Table View - Simplified -->
    <div class="table-responsive d-none d-md-block">
        <table id="result_table" class="table table-sm tableRowHover">
            <thead class="thead-dark">
            <tr>
                <th style="width:30%; text-align:left; padding-left:16px;">파일명</th>
                <th style="width:10%; text-align:center;">상태</th>
                <th style="width:30%; text-align:center;">진행률</th>
                <th style="width:12%; text-align:center;">속도</th>
                <th style="width:10%; text-align:center;">시작시간</th>
                <th style="width:8%; text-align:center;">Action</th>
            </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div id="list_mobile" class="d-md-none"></div>

    <script type="text/javascript">
        const package_name = "{{arg['package_name'] }}";
        const sub = "{{arg['sub'] }}";
        var current_data = null;

        function on_start(silent = false) {
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/entity_list',
                type: "POST",
                cache: false,
                data: {},
                dataType: "json",
                global: !silent,
                success: function (data) {
                    current_data = data;
                    
                    const list_body = $("#list");
                    const list_mobile = $("#list_mobile");
                    
                    if (data.length == 0) {
                        list_body.html("<tr><td colspan='6' class='text-center py-5'><div class='empty-state'><i class='fa fa-inbox fa-3x mb-3' style='opacity:0.3'></i><h5>작업이 없습니다</h5></div></td></tr>");
                        list_mobile.html("<div class='text-center p-5'><i class='fa fa-inbox fa-3x mb-3' style='opacity:0.3'></i><h5>작업이 없습니다</h5></div>");
                    } else {
                        // Table View update
                        var str_table = '';
                        for (i in data) str_table += make_item(data[i]);
                        list_body.html(str_table);
                        
                        // Mobile Card View update
                        var str_mobile = '';
                        for (i in data) str_mobile += make_item_mobile(data[i]);
                        list_mobile.html(str_mobile);
                    }
                }
            });
        }

        $(document).ready(function () {
            const socket_url = window.location.protocol + "//" + document.domain + ":" + location.port + "/anime_downloader/anilife/queue";
            const socket = io.connect(socket_url);

            socket.on('connect', function() {});
            
            socket.on('start', function (data) { on_start(); });
            socket.on('list_refresh', function (data) { on_start(); });
            socket.on('status', function (data) { status_html(data); });
            socket.on('add', function (data) {
                if (current_data == null || current_data.length == 0) {
                    current_data = Array();
                    $("#list").html(make_item(data));
                    $("#list_mobile").html(make_item_mobile(data));
                } else {
                    $("#list").append(make_item(data));
                    $("#list_mobile").append(make_item_mobile(data));
                }
                current_data.push(data);
            });

            // 3초마다 자동 새로고침
            setInterval(function() { on_start(true); }, 3000);

            // 초기 로드
            globalSendCommand('list', null, null, null, function (data) {
                current_data = data;
                $("#list").html('');
                $("#list_mobile").html('');
                if (data.length == 0) {
                    $("#list").html("<tr><td colspan='6' class='text-center py-5'><div class='empty-state'><i class='fa fa-inbox fa-3x mb-3' style='opacity:0.3'></i><h5>작업이 없습니다</h5></div></td></tr>");
                    $("#list_mobile").html("<div class='text-center p-5'><i class='fa fa-inbox fa-3x mb-3' style='opacity:0.3'></i><h5>작업이 없습니다</h5></div>");
                } else {
                    var str_table = '';
                    var str_mobile = '';
                    for (i in data) {
                        str_table += make_item(data[i]);
                        str_mobile += make_item_mobile(data[i]);
                    }
                    $("#list").html(str_table);
                    $("#list_mobile").html(str_mobile);
                }
            });
        });

        $("body").on('click', '#stop_btn', function (e) {
            e.stopPropagation();
            e.preventDefault();
            var idx = $(this).data('idx');
            globalSendCommand('stop', idx, null, null, function (ret) { on_start(); });
        });

        function make_item_mobile(data) {
            var statusClass = get_status_class(data.status_str);
            var str = '<div class="queue-card mb-3" id="card_' + data.idx + '">';
            str += '  <div class="card-header-flex">';
            str += '    <span id="card_status_kor_' + data.idx + '" class="status-badge ' + statusClass + '">' + data.status_kor + '</span>';
            str += '  </div>';
            str += '  <div class="card-content">';
            str += '    <div class="card-filename">' + data.filename + '</div>';
            str += '    <div class="progress mt-3 mb-2" style="height: 8px;">';
            str += '      <div id="card_progress_bar_' + data.idx + '" class="progress-bar" style="width:' + data.percent + '%;"></div>';
            str += '    </div>';
            str += '    <div class="card-meta">';
            str += '      <div class="meta-item"><i class="fa fa-bolt"></i> <span id="card_current_speed_' + data.idx + '">' + (data.current_speed || '-') + '</span></div>';
            str += '      <div class="meta-item"><i class="fa fa-clock-o"></i> <span>' + (data.start_time || '-') + '</span></div>';
            str += '    </div>';
            str += '  </div>';
            str += '  <div id="card_button_' + data.idx + '" class="card-footer-actions">';
            if (data.status_str == 'DOWNLOADING' || data.status_str == 'EXTRACTING' || data.status_str == 'PENDING') {
                str += '    <button id="stop_btn" class="action-btn btn-stop w-100" data-idx="' + data.idx + '"><i class="fa fa-stop mr-1"></i> 중지</button>';
            }
            str += '  </div>';
            str += '</div>';
            return str;
        }

        function make_item(data) {
            var statusClass = get_status_class(data.status_str);
            var str = '<tr id="tr1_' + data.idx + '">';
            str += '<td style="text-align:left; padding-left:16px; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + data.filename + '">' + data.filename + '</td>';
            str += '<td id="status_' + data.idx + '" style="text-align:center;"><span class="status-badge ' + statusClass + '">' + data.status_kor + '</span></td>';
            str += '<td style="text-align:center;"><div class="progress" style="height:20px;"><div id="progress_' + data.idx + '" class="progress-bar" style="width:' + data.percent + '%">' + data.percent + '%</div></div></td>';
            str += '<td id="current_speed_' + data.idx + '" style="text-align:center;">' + (data.current_speed || '-') + '</td>';
            str += '<td style="text-align:center; font-size:0.85em;">' + (data.start_time ? data.start_time.split(' ')[1] || data.start_time : '-') + '</td>';
            str += '<td id="button_' + data.idx + '" style="text-align:center;">';
            if (data.status_str == 'DOWNLOADING' || data.status_str == 'EXTRACTING' || data.status_str == 'PENDING') {
                str += '<button id="stop_btn" class="action-btn btn-stop" data-idx="' + data.idx + '"><i class="fa fa-stop"></i></button>';
            }
            str += '</td>';
            str += '</tr>';
            return str;
        }

        function get_status_class(status_str) {
            var s = (status_str || '').toLowerCase();
            if (s == 'completed') return 'status-completed';
            if (s == 'downloading') return 'status-downloading';
            if (s == 'extracting') return 'status-extracting';
            if (s == 'pending') return 'status-pending';
            if (s == 'error' || s == 'fail') return 'status-fail';
            if (s == 'cancelled') return 'status-cancelled';
            return 'status-pending';
        }

        function status_html(data) {
            // Table Update
            var progress = document.getElementById("progress_" + data.idx);
            if (progress) {
                progress.style.width = data.percent + '%';
                progress.innerHTML = data.percent + '%';
                var statusEl = document.getElementById("status_" + data.idx);
                if (statusEl) statusEl.innerHTML = '<span class="status-badge ' + get_status_class(data.status_str) + '">' + data.status_kor + '</span>';
                var speedEl = document.getElementById("current_speed_" + data.idx);
                if (speedEl) speedEl.innerHTML = data.current_speed || '-';
            }

            // Mobile Card Update
            var card_progress = document.getElementById("card_progress_bar_" + data.idx);
            if (card_progress) {
                card_progress.style.width = data.percent + '%';
                var status_badge = document.getElementById("card_status_kor_" + data.idx);
                if (status_badge) {
                    status_badge.innerHTML = data.status_kor;
                    status_badge.className = 'status-badge ' + get_status_class(data.status_str);
                }
                var card_speed = document.getElementById("card_current_speed_" + data.idx);
                if (card_speed) card_speed.innerHTML = data.current_speed || '-';
            }
        }

        $("body").on('click', '#reset_btn', function (e) {
            e.preventDefault();
            if (!confirm('모든 항목을 초기화하시겠습니까?')) return;
            queue_command({'command': 'reset', 'entity_id': -1});
        });

        $("body").on('click', '#delete_completed_btn', function (e) {
            e.preventDefault();
            queue_command({'command': 'delete_completed', 'entity_id': -1});
        });

        $("body").on('click', '#go_gdm_btn', function (e) {
            e.preventDefault();
            window.location.href = '/gommi_downloader_manager/queue/list';
        });

        function queue_command(data) {
            $.ajax({
                url: '/' + package_name + '/ajax/' + sub + '/queue_command',
                type: "POST",
                cache: false,
                data: data,
                dataType: "json",
                success: function (ret) {
                    if (ret.ret == 'notify') {
                        $.notify('<strong>' + ret.log + '</strong>', {type: 'warning'});
                    } else if (ret.ret == 'success' || ret == true) {
                        $.notify('명령을 완료했습니다.', {type: 'success'});
                    }
                    on_start();
                }
            });
        }
    </script>

<style>
    /* ========== Cosmic Violet Theme (Anilife Queue) ========== */
    body {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 40%, #4c1d95 100%) !important;
        background-attachment: fixed;
        color: #e0e7ff;
        min-height: 100vh;
        font-family: 'Inter', 'Noto Sans KR', system-ui, sans-serif;
    }
    
    /* 좌우 여백 축소 */
    .container, .container-fluid {
        max-width: 100% !important;
        padding-left: 12px !important;
        padding-right: 12px !important;
    }
    #content, .content, main {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    /* Table Styling */
    .table {
        color: #e0e7ff !important;
        background: rgba(49, 46, 129, 0.4) !important;
        border-radius: 12px;
        overflow: hidden;
    }
    .table thead th, .thead-dark th {
        background: linear-gradient(135deg, rgba(76, 29, 149, 0.9) 0%, rgba(49, 46, 129, 0.9) 100%) !important;
        color: #c4b5fd !important;
        border-color: rgba(167, 139, 250, 0.2) !important;
        font-weight: 600;
        font-size: 0.9em;
    }
    .table tbody tr {
        background: rgba(30, 27, 75, 0.6) !important;
        transition: background 0.2s;
    }
    .table tbody tr:hover {
        background: rgba(76, 29, 149, 0.5) !important;
    }
    .table td, .table th {
        border-color: rgba(167, 139, 250, 0.15) !important;
        color: #e0e7ff !important;
        vertical-align: middle !important;
    }

    /* Status Badges */
    .status-badge {
        font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 50rem;
        text-transform: uppercase; letter-spacing: 0.3px; display: inline-block;
    }
    .status-completed { background: rgba(34, 197, 94, 0.25); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }
    .status-downloading { background: rgba(59, 130, 246, 0.25); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }
    .status-extracting { background: rgba(168, 85, 247, 0.25); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.4); }
    .status-pending { background: rgba(148, 163, 184, 0.2); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }
    .status-fail { background: rgba(239, 68, 68, 0.25); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
    .status-cancelled { background: rgba(107, 114, 128, 0.25); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.4); }

    /* Progress Bar */
    .progress {
        background: rgba(49, 46, 129, 0.6) !important;
        border-radius: 10px;
        overflow: hidden;
    }
    .progress-bar {
        background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%) !important;
        font-size: 11px;
        font-weight: 600;
        transition: width 0.3s ease;
    }

    /* Buttons */
    .custom-btn {
        padding: 8px 18px; border-radius: 10px; font-weight: 600; font-size: 13px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255, 255, 255, 0.1);
        display: inline-flex; align-items: center; justify-content: center; color: white !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .btn-reset-queue { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3); }
    .btn-reset-queue:hover { background: rgba(59, 130, 246, 0.4); transform: translateY(-2px); }
    .btn-delete-completed { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.3); }
    .btn-delete-completed:hover { background: rgba(239, 68, 68, 0.4); transform: translateY(-2px); }
    .btn-gdm { background: rgba(56, 189, 248, 0.2); border-color: rgba(56, 189, 248, 0.3); }
    .btn-gdm:hover { background: rgba(56, 189, 248, 0.4); transform: translateY(-2px); }

    .action-btn {
        padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
        transition: all 0.2s; border: 1px solid transparent; background: transparent;
    }
    .btn-stop { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
    .btn-stop:hover { background: #ef4444; color: white; }

    /* Mobile Card Styles */
    .queue-card {
        background: rgba(30, 27, 75, 0.5);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(167, 139, 250, 0.15);
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s;
    }
    .queue-card:hover { border-color: rgba(167, 139, 250, 0.4); transform: translateY(-2px); }
    .card-header-flex {
        padding: 10px 16px;
        background: rgba(49, 46, 129, 0.3);
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }
    .card-content { padding: 16px; }
    .card-filename {
        font-size: 15px; font-weight: 600; color: #f8fafc;
        line-height: 1.4; word-break: break-all;
    }
    .card-meta {
        display: flex; justify-content: space-between; margin-top: 12px;
        padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .meta-item {
        display: flex; align-items: center; gap: 6px;
        font-size: 12px; color: #94a3b8;
    }
    .meta-item i { color: #a78bfa; }
    .card-footer-actions { padding: 0 16px 16px 16px; }

    /* Empty State */
    .empty-state { color: #64748b; }

    /* Nav Pills Override */
    ul.nav.nav-pills.bg-light {
        background-color: rgba(30, 41, 59, 0.6) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 50rem !important;
        padding: 6px !important;
        display: inline-flex !important;
        width: auto !important;
        margin-bottom: 20px;
    }
    ul.nav.nav-pills .nav-item { margin: 2px; }
    ul.nav.nav-pills .nav-link {
        border-radius: 50rem !important;
        padding: 8px 20px !important;
        color: #94a3b8 !important;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    ul.nav.nav-pills .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); color: #fff !important; }
    ul.nav.nav-pills .nav-link.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
        color: #fff !important;
    }

    /* Mobile Fix */
    @media (max-width: 768px) {
        body { overflow-x: hidden !important; }
        .container, .container-fluid, .row, form {
            width: 100% !important; max-width: 100% !important;
            padding-left: 4px !important; padding-right: 4px !important;
            margin-left: 0 !important; margin-right: 0 !important;
        }
    }
</style>

<script type="text/javascript">
$(document).ready(function(){
    setTimeout(function() {
        $('.content-cloak, #menu_module_div, #menu_page_div').addClass('visible');
    }, 100);
});
</script>
{% endblock %}
